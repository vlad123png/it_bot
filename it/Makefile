# –ü–æ–¥–∫–ª—é—á–∞–µ–º .env ‚Äî —á—Ç–æ–±—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –±—ã–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ã –≤ make
include .env
export

.PHONY: build run lint revision migrate rollback down logs up stop

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º COMPOSE_FILE –Ω–∞ –æ—Å–Ω–æ–≤–µ CONTOUR (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é prod)
ifeq ($(CONTOUR), DEV)
COMPOSE_FILE ?= docker-compose.dev.yaml
else
COMPOSE_FILE ?= docker-compose.yaml
endif

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º PROJECT_NAME –Ω–∞ –æ—Å–Ω–æ–≤–µ .env –∏ –ø—Ä–∏–≤–æ–¥–∏–º –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É
UNSAFE_PROJECT_NAME := $(strip $(if $(APP_NAME),$(APP_NAME),$(if $(CONTOUR),myapp-$(CONTOUR),myapp)))
SAFE_PROJECT_NAME := $(shell echo '$(UNSAFE_PROJECT_NAME)' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9_-]//g')
PROJECT_NAME := $(if $(SAFE_PROJECT_NAME),$(SAFE_PROJECT_NAME),myapp)

# Docker Compose –∫–æ–º–∞–Ω–¥–∞ —Å project name –∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∞–π–ª–æ–º
DC := docker compose -p $(PROJECT_NAME) -f $(COMPOSE_FILE) --env-file .env

# –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑
build:
	$(DC) build

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞ (–∏ –ë–î, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
up:
	$(DC) up -d --build

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–æ—Ç–∞
stop:
	$(DC) stop

down:
	$(DC) down

# –õ–æ–≥–∏
logs:
	$(DC) logs -f retail_bot

# –ú–∏–≥—Ä–∞—Ü–∏–∏ ‚Äî –≤—ã–ø–æ–ª–Ω—è–µ–º –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –±–æ—Ç–∞
migrate:
	$(DC) exec retail_bot alembic upgrade head

revision:
ifndef NAME
	$(error NAME is undefined, try: make revision NAME="–æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π")
endif
	$(DC) exec retail_bot alembic revision --autogenerate -m "$(NAME)"

rollback:
ifndef NUM
	$(error NUM is undefined, try: make rollback NUM="-1" or NUM="base")
endif
	$(DC) exec retail_bot alembic downgrade $(NUM)

# –ü–æ–º–æ—â—å
help:
	@echo "üõ†Ô∏è  Available commands:"
	@echo "   make up           # –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã"
	@echo "   make down         # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏ —É–¥–∞–ª–∏—Ç—å"
	@echo "   make logs         # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏"
	@echo "   make build        # –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –æ–±—Ä–∞–∑"
	@echo "   make migrate      # –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
	@echo "   make revision NAME='...' # –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é"
	@echo "   make rollback NUM=-1     # –û—Ç–∫–∞—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
	@echo ""
	@echo "üí° –ò—Å–ø–æ–ª—å–∑—É–π: ENV=dev make ... –¥–ª—è dev-–æ–∫—Ä—É–∂–µ–Ω–∏—è"
	@echo "   (–Ω–∞–ø—Ä–∏–º–µ—Ä: ENV=dev make up)"